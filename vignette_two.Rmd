---
title: "cron jobs w/ betfaiR"
---

```{r set-knitr, echo=FALSE}
library(knitr)
opts_chunk$set(comment = NA)
```
This vignette will walk through the use of `betfaiR` to collect data over time - the markets we will focus on is the match odds markets for Man City vs Spurs and Arsenal vs Leicester, as well as the Premier League outright market.  However this approach can be used for collecting data about other markets, to potentially build models and establish trading strategies.

I will try to explain how to perform similar tasks on both Windows and Linux/OSX machines, this will involve creating an R script and using a Task scheduler (Task Scheduler on Windows and [cron](https://en.wikipedia.org/wiki/Cron) on Linux/OSX); this [blog](https://trinkerrstuff.wordpress.com/2015/02/11/scheduling-r-tasks-via-windows-task-scheduler/) by [Tyler Rinker](https://twitter.com/tylerrinker) has been very useful to me.

As an example, the plot below shows the minute by minute Betfair price data during the course of a football match between Manchester United and Manchester City:

<img src="manchester-derby.jpeg" style="display: block; margin-left: auto; margin-right: auto">

There are a few things that we will need to do:

* to create an R script that will use changing variables
    * variables will be the marketIds which will change day to day
* to store data in .RDS or RData files, data will include
    * marketId
    * returned market data

## Find markets

First, some familiarity with events, competitions, and markets will help with creating an R script to automate the collection of data.  As we are focussing on the Premier League, we need an eventTypeId, a competitionId, which will help us to find the markets we are interested in.

```{r login-and-search}
# load betfaiR and login
library(betfaiR)
bf <- betfair(usr = Sys.getenv("BETFAIR_USR"),
              pwd = Sys.getenv("BETFAIR_PWD"),
              key = Sys.getenv("BETFAIR_KEY"))

# find correct eventTypeIds
eventTypeIds <- bf$eventTypes()
eventTypeIds[grepl("soccer|football", eventTypeIds$eventType_name, ignore.case = TRUE),]
# soccer/football has eventTypeId of 1, lets use that along with marketCountries to find the Premier League competition
competitions <- bf$competitions(filter = marketFilter(eventTypeIds = 1,
                                                      marketCountries = "GB"))
competitions[grepl("premier", competitions$competition_name, ignore.case =  TRUE),]
# the Premier League has a competition id of 31, we can find the different market types for this competition
marketTypes <- bf$marketTypes(filter = marketFilter(competitionIds = 31))
```
```{r show-marketTypes, echo=FALSE}
marketTypes[grepl("WINNER|MATCH_ODDS", marketTypes$marketType),]
```

The marketIds of the two matches (Man City vs Spurs and Arsenal vs Leicester) and the outright winner of the Premier League are shown below:

The following are the three markets of interest, which were collected and saved sometime on Weds 10th Feb 2016.

```{r show-markets, echo=FALSE}
marketIds <- readRDS("vignette_two/marketIds.RDS")
plyr::l_ply(marketIds, summary)
```

## R script

A script will need to login, find the correct markets, retreive the relevant data, and then save the data.  The process of finding the correct markets needn't be repeated time after time, so this data can be retrieved once, saved and then loaded every time.  Although the script needs to be able to run straight off the bat, so it might look something like the code below:

```{r example-login, eval=FALSE}
library(betfaiR)

bf <- betfair(usr = Sys.getenv("BETFAIR_USR"),
              pwd = Sys.getenv("BETFAIR_PWD"),
              key = Sys.getenv("BETFAIR_KEY"))

files <- list.files()

if(!("marketIds.RDS" %in% files)) {
    cittot <- bf$marketCatalogue(filter = marketFilter(competitionIds = 31,
                                                       textQuery = "Tottenham",
                                                       to = "2016-02-15",
                                                       marketTypeCodes = "MATCH_ODDS"),
                                 maxResults = 10)
    arslei <- bf$marketCatalogue(filter = marketFilter(competitionIds = 31,
                                                       textQuery = "Arsenal",
                                                       to = "2016-02-15",
                                                       marketTypeCodes = "MATCH_ODDS"),
                                 maxResults = 10)
    winner <- bf$marketCatalogue(filter = marketFilter(competitionIds = 31,
                                                       marketTypeCodes = "WINNER"))
    marketIds <- list(cittot = cittot, arslei = arslei, winner = winner)
    saveRDS(marketIds, "marketIds.RDS")
} else {
    marketIds <- readRDS("marketIds.RDS")
}
```

The complete R script which will be run each time can be found at the [bottom of this page](http://durtal.github.io/betfaiR/vignette_two.html#complete-r-script) or on [github](https://github.com/durtal/betfaiR/blob/gh-pages/vignette_two/collect_data.R), the script is commented so you should be able to follow it.

## schedule tasks

Tasks will be run every minute on Sunday 14th Feb between 10am (GMT) and 7pm (GMT).  So data might catch pre-match team announcment movements, and how these may ripple over other markets.

### windows

Windows does have a GUI to help with Scheduling tasks (read about that [here](http://windows.microsoft.com/en-gb/windows/schedule-task#1TC=windows-7)) but some of it is quite restrictive, eg. you can (Windows 8) only schedule a task to run every 5minutes.  So we will be using the command line as an administrator, docs about the arguments which can be used can be found [here](https://msdn.microsoft.com/en-us/library/windows/desktop/bb736357(v=vs.85).aspx).

The command entered for this task will be

```bash
schtasks /create /sc minute /sd 14/02/2016 /st 10:00 /ed 14/02/2016 /et 19:00 /tn betfairsupersunday /tr C:\Users\TomHeslop\Documents\Github\betfaiR\vignette_two\task.bat
```

So walking through that:

1. `schtasks /create` creates a task, what follows are the arguments or parameters
2. `/sc minute /sd 14/02/2016 /st 10:00` informs the schedule frequency (`/sc minute`), the start date (`/sd 14/02/2016`) and the start time (`/st 10:00`)
3. `/ed 14/02/2016 /et 19:00` informs the end date (`/ed 14/02/2016`) and the end time (`/et 19:00`)
4. `/tn betfairsupersunday` informs the task name so it can be found/deleted/updated
5. `/tr C:\Users\TomHeslop\Documents\Github\betfaiR\vignette_two\task.bat` informs the task to run, in this case the [task.bat](https://github.com/durtal/betfaiR/blob/gh-pages/vignette_two/task.bat) file

I used a couple of additional parameters, `/ru` and `/rp`, which informs the scheduler to run the task under a certain user (`/ru`, and their password `/rp`), this means that the CMD prompt won't pop up every minute when the task launches, and the task will run quietly.

### linux and osx

[crontab](http://crontab.org/) (which may require installation) isn't as familiar to me as windows, so any input/corrections would be very welcome.  It involves editing a file with your tasks.  For each task there are 6 categories, some examples are below (taken from [cronhowto](https://help.ubuntu.com/community/CronHowto)):

min | hour | day | month | weekday | command | task
----|------|-----|-------|---------|---------|----------------------------------
01  | 04   | 1   | 1     | 1       | /usr/bin/somedirectory/somecommand | run on Jan 1st (and every monday in January) at 04:01am
01  | 04   | *   | *     | *       | /usr/bin/somedirectory/somecommand | run every day of every month at 04:01am

Unlike Windows I don't believe it's easy (or more likely I don't know how) to set a start and end time, nevertheless the task would possibly look something like below

```bash
*/1 10,11,12,13,14,15,16,17,18,19 14 2 0 Rscript /path/to/collect_data.R
```

Walking through the above (hopefully correctly):

1. `*/1` informs which minutes the task should be run, I believe this means every minute, * is wildcard for all, and /1 means divisible by 1, so */10 would be minutes 10, 20, 30, 40, 50.
2. `10,11,12,13,14,15,16,17,18,19` informs the hours to run the task, 10am through to 7pm
3. `14` informs the day of the month
4. `2` informs the month
5. `0` informs the day, 0 is Sunday
6. `Rscript /path/to/collect_data.R` is the task to run

I think the above should ensure the task is run once on the 14th of Feb 2016, and it'll be a 2021 when the 14th of Feb falls on a Sunday again, so plenty of time to delete the task :-)

## part two - findings

A short post looking at the data returned by using the code outlined in this post can be found [here](http://durtal.github.io/betfaiR/vignette_three.html).

## complete R script

```{r read-r-script, echo=FALSE}
r <- paste0(readLines("vignette_two/collect_data.R", warn = FALSE), collapse = "\n")
```
The script below is called every time a task runs.  So we first load libraries, set our working environment and log in to betfair via the [`betfair`](http://durtal.github.io/betfaiR/betfair.html) function.  We then retrieve the files in our current directory, to establish whether there is a marketIds.RDS file we can load, or whether we need to retrieve the marketIds, as discussed above.

The next steps save the current time - to help with comparing data from the three markets - which will be added to each of the markets' data.  The code then establishes whether the market is still available using the [`marketCatalogue`](http://durtal.github.io/betfaiR/methods_marketCatalogue.html) method; Arsenal vs Leicester kics off at 12pm so will be finished and closed before Man City vs Tottenham.  So the `available_markets` variable becomes the markets whose data we will retrieve.

We then loop through these `available_markets` and retrieve data via the [`marketBook`](http://durtal.github.io/betfaiR/methods_marketBook.html) method.  We will read in any existing data for this market, append the newly returned data (gradually building a larger and larger list) to the existing data, and then save our updated list.

```r
`r r`
```

<a href="https://github.com/durtal/betfaiR" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#d9230f; color:#fcfcfc; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
