<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>cron jobs w/ betfaiR</title>

<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/united.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<style type="text/css">

	/* padding for bootstrap navbar */
	body {
		padding-top: 20px;
		padding-bottom: 20px;
	}
	@media (max-width: 979px) {
		body {
			padding-top: 0;
		}
	}

	/* offset scroll position for anchor links (for fixed navbar) */
	@media (min-width: 980px) {
		.section h2 {
			padding-top: 52px;
			margin-top: -52px;
		}
		.section h3 {
			padding-top: 52px;
			margin-top: -52px;
		}
	}

	p {
		font-size: 13px;
	}

	/* don't use link color in navbar */
	.dropdown-menu>li>a {
		color: black;
	}

	/* some padding for disqus */
	#disqus_thread {
		margin-top: 45px;
	}

</style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->





<h1>betfaiR</h1>
<nav class="navbar navbar-inverse">
    <div class="container-fluid">
        <div class="navbar-header">
            <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#betfaiR-nav">
                <span class="sr-only">Toggle Navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a href="https://github.com/durtal" class="navbar-brand">durtal@github</a>
        </div>
        <div class="collapse navbar-collapse" id="betfaiR-nav">
            <ul class="nav navbar-nav">
                <li>
                    <a href="index.html">home</a>
                </li>
                <li class="dropdown">
                    <a href="Primary" class="dropdown-toggle" data-toggle="dropdown">
                        functions <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-header">environment</li>
                        <li>
                            <a href="betfair.html">betfair</a>
                        </li>
                        <li class="dropdown-header">functions</li>
                        <li>
                            <a href="betfair_login.html">bf_login</a>
                        </li>
                        <li>
                            <a href="bf_account.html">bf_account</a>
                        </li>
                        <li>
                            <a href="request_functions.html">bf_request</a>
                        </li>
                        <li>
                            <a href="betfair_POST.html">bf_post</a>
                        </li>
                        <li>
                            <a href="betfair_check.html">bf_check</a>
                        </li>
                        <li>
                            <a href="betfair_parse.html">bf_parse</a>
                        </li>
                        <li class="dropdown-header">helpers</li>
                        <li>
                            <a href="marketFilter.html">marketFilter</a>
                        </li>
                        <li>
                            <a href="bf_helpers.html">bet instructions</a>
                        </li>
                        <li>
                            <a href="betfair_theme.html">betfair_theme</a>
                        </li>
                    </ul>
                </li>
                <li class="dropdown">
                    <a href="Methods" class="dropdown-toggle" data-toggle="dropdown">
                        methods <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li class="dropdown-header">summary data</li>
                        <li>
                            <a href="methods_competitions.html">competitions</a>
                        </li>
                        <li>
                            <a href="methods_countries.html">countries</a>
                        </li>
                        <li>
                            <a href="methods_events.html">events</a>
                        </li>
                        <li>
                            <a href="methods_eventTypes.html">eventTypes</a>
                        </li>
                        <li>
                            <a href="methods_venues.html">venues</a>
                        </li>
                        <li class="dropdown-header">login</li>
                        <li>
                            <a href="login_session.html">login + session</a>
                        </li>
                        <li class="dropdown-header">market data</li>
                        <li>
                            <a href="methods_marketTypes.html">marketTypes</a>
                        </li>
                        <li>
                            <a href="methods_marketCatalogue.html">marketCatalogue</a>
                        </li>
                        <li>
                            <a href="methods_marketBook.html">marketBook</a>
                        </li>
                        <li>
                            <a href="methods_marketPnL.html">marketPnL</a>
                        </li>
                        <li class="dropdown-header">orders</li>
                        <li>
                            <a href="cancelOrders.html">cancelOrders</a>
                        </li>
                        <li>
                            <a href="clearedOrders.html">clearedOrders</a>
                        </li>
                        <li>
                            <a href="currentOrders.html">currentOrders</a>
                        </li>
                        <li>
                            <a href="placeOrders.html">placeOrders</a>
                        </li>
                        <li>
                            <a href="replaceOrders.html">replaceOrders</a>
                        </li>
                        <li>
                            <a href="updateOrders.html">updateOrders</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="Misc" class="dropdown-toggle" data-toggle="dropdown">
                        misc <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="betting_enums.html">Betting Enums</a>
                        </li>
                    </ul>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li class="dropdown">
                    <a href="vignettes" class="dropdown-toggle" data-toggle="dropdown">
                        vignettes <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                            <a href="vignette_one.html">place a bet</a>
                        </li>
                        <li>
                            <a href="vignette_two.html">cron jobs w/ betfaiR (pt.1)</a>
                        </li>
                        <li>
                            <a href="vignette_three.html">betfair super sunday (pt.2)</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">cron jobs w/ betfaiR</h1>

</div>


<p>This vignette will walk through the use of <code>betfaiR</code> to collect data over time - the markets we will focus on is the match odds markets for Man City vs Spurs and Arsenal vs Leicester, as well as the Premier League outright market. However this approach can be used for collecting data about other markets, to potentially build models and establish trading strategies.</p>
<p>I will try to explain how to perform similar tasks on both Windows and Linux/OSX machines, this will involve creating an R script and using a Task scheduler (Task Scheduler on Windows and <a href="https://en.wikipedia.org/wiki/Cron">cron</a> on Linux/OSX); this <a href="https://trinkerrstuff.wordpress.com/2015/02/11/scheduling-r-tasks-via-windows-task-scheduler/">blog</a> by <a href="https://twitter.com/tylerrinker">Tyler Rinker</a> has been very useful to me.</p>
<p>As an example, the plot below shows the minute by minute Betfair price data during the course of a football match between Manchester United and Manchester City:</p>
<p><img src="manchester-derby.jpeg" style="display: block; margin-left: auto; margin-right: auto"></p>
<p>There are a few things that we will need to do:</p>
<ul>
<li>to create an R script that will use changing variables
<ul>
<li>variables will be the marketIds which will change day to day</li>
</ul></li>
<li>to store data in .RDS or RData files, data will include
<ul>
<li>marketId</li>
<li>returned market data</li>
</ul></li>
</ul>
<div id="find-markets" class="section level2">
<h2>Find markets</h2>
<p>First, some familiarity with events, competitions, and markets will help with creating an R script to automate the collection of data. As we are focussing on the Premier League, we need an eventTypeId, a competitionId, which will help us to find the markets we are interested in.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># load betfaiR and login</span>
<span class="kw">library</span>(betfaiR)
bf &lt;-<span class="st"> </span><span class="kw">betfair</span>(<span class="dt">usr =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;bf_usr&quot;</span>),
              <span class="dt">pwd =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;bf_pwd&quot;</span>),
              <span class="dt">key =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;bf_key&quot;</span>))</code></pre></div>
<pre><code>Login successful</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># find correct eventTypeIds</span>
eventTypeIds &lt;-<span class="st"> </span>bf$<span class="kw">eventTypes</span>()
eventTypeIds[<span class="kw">grepl</span>(<span class="st">&quot;soccer|football&quot;</span>, eventTypeIds$eventType_name, <span class="dt">ignore.case =</span> <span class="ot">TRUE</span>),]</code></pre></div>
<pre><code>   eventType_id    eventType_name marketCount
1             1            Soccer        8078
20         6423 American Football          23</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># soccer/football has eventTypeId of 1, lets use that along with marketCountries to find the Premier League competition</span>
competitions &lt;-<span class="st"> </span>bf$<span class="kw">competitions</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">eventTypeIds =</span> <span class="dv">1</span>,
                                                      <span class="dt">marketCountries =</span> <span class="st">&quot;GB&quot;</span>))
competitions[<span class="kw">grepl</span>(<span class="st">&quot;premier&quot;</span>, competitions$competition_name, <span class="dt">ignore.case =</span>  <span class="ot">TRUE</span>),]</code></pre></div>
<pre><code>   competition_id                           competition_name marketCount
2         6447264      Northern Premier League Challenge Cup          48
5         4644737 Northern Premier League Division One South          24
7        10403285                         Premier League Cup          48
17             31                     English Premier League         322
22            105                       Scottish Premiership          99
23         820582                           Isthmian Premier          24
29        4644728 Northern Premier League Division One North          72
   competitionRegion
2                GBR
5                GBR
7                GBR
17               GBR
22               GBR
23               GBR
29               GBR</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># the Premier League has a competition id of 31, we can find the different market types for this competition</span>
marketTypes &lt;-<span class="st"> </span>bf$<span class="kw">marketTypes</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>))</code></pre></div>
<pre><code>   marketType marketCount
3      WINNER           1
22 MATCH_ODDS          20</code></pre>
<p>The marketIds of the two matches (Man City vs Spurs and Arsenal vs Leicester) and the outright winner of the Premier League are shown below:</p>
<p>The following are the three markets of interest, which were collected and saved sometime on Weds 10th Feb 2016.</p>
<pre><code>
Market ID:      1.122843814
Event ID:       27674404 
Market Name:    Match Odds
Event Name:     Man City v Tottenham 
Matched:        224247.78

Runners:     3 
 selectionId runnerName handicap sortPriority
       47999   Man City        0            1
       48224  Tottenham        0            2
       58805   The Draw        0            3

 ---------------------------------------------------------------------------
Market ID:      1.122843669
Event ID:       27674402 
Market Name:    Match Odds
Event Name:     Arsenal v Leicester 
Matched:        206538.46

Runners:     3 
 selectionId runnerName handicap sortPriority
        1096    Arsenal        0            1
       48461  Leicester        0            2
       58805   The Draw        0            3

 ---------------------------------------------------------------------------
Market ID:      1.118280148
Event ID:       2022802 
Market Name:    2015/16 Winner
Event Name:     Barclays Premier League 
Matched:        13511634.58

Runners:     20 
 selectionId runnerName handicap sortPriority
        1096    Arsenal        0            1
       48461  Leicester        0            2
       47999   Man City        0            3
       48224  Tottenham        0            4
       48351    Man Utd        0            5
       48756   West Ham        0            6

 ---------------------------------------------------------------------------</code></pre>
</div>
<div id="r-script" class="section level2">
<h2>R script</h2>
<p>A script will need to login, find the correct markets, retreive the relevant data, and then save the data. The process of finding the correct markets needn’t be repeated time after time, so this data can be retrieved once, saved and then loaded every time. Although the script needs to be able to run straight off the bat, so it might look something like the code below:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(betfaiR)

bf &lt;-<span class="st"> </span><span class="kw">betfair</span>(<span class="dt">usr =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_USR&quot;</span>),
              <span class="dt">pwd =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_PWD&quot;</span>),
              <span class="dt">key =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_KEY&quot;</span>))

files &lt;-<span class="st"> </span><span class="kw">list.files</span>()

if(!(<span class="st">&quot;marketIds.RDS&quot;</span> %in%<span class="st"> </span>files)) {
    cittot &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">textQuery =</span> <span class="st">&quot;Tottenham&quot;</span>,
                                                       <span class="dt">to =</span> <span class="st">&quot;2016-02-15&quot;</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;MATCH_ODDS&quot;</span>),
                                 <span class="dt">maxResults =</span> <span class="dv">10</span>)
    arslei &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">textQuery =</span> <span class="st">&quot;Arsenal&quot;</span>,
                                                       <span class="dt">to =</span> <span class="st">&quot;2016-02-15&quot;</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;MATCH_ODDS&quot;</span>),
                                 <span class="dt">maxResults =</span> <span class="dv">10</span>)
    winner &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;WINNER&quot;</span>))
    marketIds &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">cittot =</span> cittot, <span class="dt">arslei =</span> arslei, <span class="dt">winner =</span> winner)
    <span class="kw">saveRDS</span>(marketIds, <span class="st">&quot;marketIds.RDS&quot;</span>)
} else {
    marketIds &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;marketIds.RDS&quot;</span>)
}</code></pre></div>
<p>The complete R script which will be run each time can be found at the <a href="http://durtal.github.io/betfaiR/vignette_two.html#complete-r-script">bottom of this page</a> or on <a href="https://github.com/durtal/betfaiR/blob/gh-pages/vignette_two/collect_data.R">github</a>, the script is commented so you should be able to follow it.</p>
</div>
<div id="schedule-tasks" class="section level2">
<h2>schedule tasks</h2>
<p>Tasks will be run every minute on Sunday 14th Feb between 10am (GMT) and 7pm (GMT). So data might catch pre-match team announcment movements, and how these may ripple over other markets.</p>
<div id="windows" class="section level3">
<h3>windows</h3>
<p>Windows does have a GUI to help with Scheduling tasks (read about that <a href="http://windows.microsoft.com/en-gb/windows/schedule-task#1TC=windows-7">here</a>) but some of it is quite restrictive, eg. you can (Windows 8) only schedule a task to run every 5minutes. So we will be using the command line as an administrator, docs about the arguments which can be used can be found <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/bb736357(v=vs.85).aspx">here</a>.</p>
<p>The command entered for this task will be</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">schtasks</span> /create /sc minute /sd 14/02/2016 /st 10:00 /ed 14/02/2016 /et 19:00 /tn betfairsupersunday /tr C:\Users\TomHeslop\Documents\Github\betfaiR\vignette_two\task.bat</code></pre></div>
<p>So walking through that:</p>
<ol style="list-style-type: decimal">
<li><code>schtasks /create</code> creates a task, what follows are the arguments or parameters</li>
<li><code>/sc minute /sd 14/02/2016 /st 10:00</code> informs the schedule frequency (<code>/sc minute</code>), the start date (<code>/sd 14/02/2016</code>) and the start time (<code>/st 10:00</code>)</li>
<li><code>/ed 14/02/2016 /et 19:00</code> informs the end date (<code>/ed 14/02/2016</code>) and the end time (<code>/et 19:00</code>)</li>
<li><code>/tn betfairsupersunday</code> informs the task name so it can be found/deleted/updated</li>
<li><code>/tr C:\Users\TomHeslop\Documents\Github\betfaiR\vignette_two\task.bat</code> informs the task to run, in this case the <a href="https://github.com/durtal/betfaiR/blob/gh-pages/vignette_two/task.bat">task.bat</a> file</li>
</ol>
<p>I used a couple of additional parameters, <code>/ru</code> and <code>/rp</code>, which informs the scheduler to run the task under a certain user (<code>/ru</code>, and their password <code>/rp</code>), this means that the CMD prompt won’t pop up every minute when the task launches, and the task will run quietly.</p>
</div>
<div id="linux-and-osx" class="section level3">
<h3>linux and osx</h3>
<p><a href="http://crontab.org/">crontab</a> (which may require installation) isn’t as familiar to me as windows, so any input/corrections would be very welcome. It involves editing a file with your tasks. For each task there are 6 categories, some examples are below (taken from <a href="https://help.ubuntu.com/community/CronHowto">cronhowto</a>):</p>
<table>
<colgroup>
<col width="6%" />
<col width="8%" />
<col width="7%" />
<col width="9%" />
<col width="12%" />
<col width="12%" />
<col width="43%" />
</colgroup>
<thead>
<tr class="header">
<th>min</th>
<th>hour</th>
<th>day</th>
<th>month</th>
<th>weekday</th>
<th>command</th>
<th>task</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>01</td>
<td>04</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>/usr/bin/somedirectory/somecommand</td>
<td>run on Jan 1st (and every monday in January) at 04:01am</td>
</tr>
<tr class="even">
<td>01</td>
<td>04</td>
<td>*</td>
<td>*</td>
<td>*</td>
<td>/usr/bin/somedirectory/somecommand</td>
<td>run every day of every month at 04:01am</td>
</tr>
</tbody>
</table>
<p>Unlike Windows I don’t believe it’s easy (or more likely I don’t know how) to set a start and end time, nevertheless the task would possibly look something like below</p>
<div class="sourceCode"><pre class="sourceCode bash"><code class="sourceCode bash"><span class="kw">*/1</span> 10,11,12,13,14,15,16,17,18,19 14 2 0 Rscript /path/to/collect_data.R</code></pre></div>
<p>Walking through the above (hopefully correctly):</p>
<ol style="list-style-type: decimal">
<li><code>*/1</code> informs which minutes the task should be run, I believe this means every minute, * is wildcard for all, and /1 means divisible by 1, so */10 would be minutes 10, 20, 30, 40, 50.</li>
<li><code>10,11,12,13,14,15,16,17,18,19</code> informs the hours to run the task, 10am through to 7pm</li>
<li><code>14</code> informs the day of the month</li>
<li><code>2</code> informs the month</li>
<li><code>0</code> informs the day, 0 is Sunday</li>
<li><code>Rscript /path/to/collect_data.R</code> is the task to run</li>
</ol>
<p>I think the above should ensure the task is run once on the 14th of Feb 2016, and it’ll be a 2021 when the 14th of Feb falls on a Sunday again, so plenty of time to delete the task :-)</p>
</div>
</div>
<div id="part-two---findings" class="section level2">
<h2>part two - findings</h2>
<p>A short post looking at the data returned by using the code outlined in this post can be found <a href="http://durtal.github.io/betfaiR/vignette_three.html">here</a>.</p>
</div>
<div id="complete-r-script" class="section level2">
<h2>complete R script</h2>
<p>The script below is called every time a task runs. So we first load libraries, set our working environment and log in to betfair via the <a href="http://durtal.github.io/betfaiR/betfair.html"><code>betfair</code></a> function. We then retrieve the files in our current directory, to establish whether there is a marketIds.RDS file we can load, or whether we need to retrieve the marketIds, as discussed above.</p>
<p>The next steps save the current time - to help with comparing data from the three markets - which will be added to each of the markets’ data. The code then establishes whether the market is still available using the <a href="http://durtal.github.io/betfaiR/methods_marketCatalogue.html"><code>marketCatalogue</code></a> method; Arsenal vs Leicester kics off at 12pm so will be finished and closed before Man City vs Tottenham. So the <code>available_markets</code> variable becomes the markets whose data we will retrieve.</p>
<p>We then loop through these <code>available_markets</code> and retrieve data via the <a href="http://durtal.github.io/betfaiR/methods_marketBook.html"><code>marketBook</code></a> method. We will read in any existing data for this market, append the newly returned data (gradually building a larger and larger list) to the existing data, and then save our updated list.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(betfaiR)
<span class="kw">setwd</span>(<span class="st">&quot;C:/Users/TomHeslop/Documents/Github/betfaiR/vignette_two/&quot;</span>)
<span class="kw">readRenviron</span>(<span class="st">&quot;~/.Renviron&quot;</span>) <span class="co"># slightly curious why I needed to do this?</span>

<span class="co"># log in</span>
bf &lt;-<span class="st"> </span><span class="kw">betfair</span>(<span class="dt">usr =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_USR&quot;</span>),
              <span class="dt">pwd =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_PWD&quot;</span>),
              <span class="dt">key =</span> <span class="kw">Sys.getenv</span>(<span class="st">&quot;BETFAIR_KEY&quot;</span>))

<span class="co"># return list of files to check whether marketIds have been collected before</span>
files &lt;-<span class="st"> </span><span class="kw">list.files</span>()
<span class="co"># if marketIds are not available collect and save them, otherwise load them</span>
if(!(<span class="st">&quot;marketIds.RDS&quot;</span> %in%<span class="st"> </span>files)) {
    cittot &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">textQuery =</span> <span class="st">&quot;Tottenham&quot;</span>,
                                                       <span class="dt">to =</span> <span class="st">&quot;2016-02-15&quot;</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;MATCH_ODDS&quot;</span>),
                                 <span class="dt">maxResults =</span> <span class="dv">10</span>,
                                 <span class="dt">marketProjection =</span> <span class="kw">c</span>(<span class="st">&quot;EVENT&quot;</span>, <span class="st">&quot;RUNNER_DESCRIPTION&quot;</span>))
    arslei &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">textQuery =</span> <span class="st">&quot;Arsenal&quot;</span>,
                                                       <span class="dt">to =</span> <span class="st">&quot;2016-02-15&quot;</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;MATCH_ODDS&quot;</span>),
                                 <span class="dt">maxResults =</span> <span class="dv">10</span>,
                                 <span class="dt">marketProjection =</span> <span class="kw">c</span>(<span class="st">&quot;EVENT&quot;</span>, <span class="st">&quot;RUNNER_DESCRIPTION&quot;</span>))
    winner &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">competitionIds =</span> <span class="dv">31</span>,
                                                       <span class="dt">marketTypeCodes =</span> <span class="st">&quot;WINNER&quot;</span>),
                                 <span class="dt">marketProjection =</span> <span class="kw">c</span>(<span class="st">&quot;EVENT&quot;</span>, <span class="st">&quot;RUNNER_DESCRIPTION&quot;</span>))
    markets &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="dt">cittot =</span> cittot, <span class="dt">arslei =</span> arslei, <span class="dt">winner =</span> winner)
    <span class="kw">saveRDS</span>(markets, <span class="st">&quot;marketIds.RDS&quot;</span>)
} else {
    markets &lt;-<span class="st"> </span><span class="kw">readRDS</span>(<span class="st">&quot;marketIds.RDS&quot;</span>)
}

<span class="co"># get current time, to allow comparison between each of the 3 markets</span>
currentTime &lt;-<span class="st"> </span><span class="kw">Sys.time</span>()
<span class="co"># extract marketIds, and their names</span>
marketIds &lt;-<span class="st"> </span><span class="kw">sapply</span>(markets, function(i) i[[<span class="dv">1</span>]]$market$marketId)
<span class="co"># use marketIds to see if markets are still available</span>
available_markets &lt;-<span class="st"> </span>bf$<span class="kw">marketCatalogue</span>(<span class="dt">filter =</span> <span class="kw">marketFilter</span>(<span class="dt">marketIds =</span> <span class="kw">as.vector</span>(marketIds)),
                                        <span class="dt">maxResults =</span> <span class="dv">3</span>)
available_markets &lt;-<span class="st"> </span><span class="kw">sapply</span>(available_markets, function(i) i$market$marketId)
<span class="co"># build logical vector</span>
test &lt;-<span class="st"> </span>marketIds %in%<span class="st"> </span>available_markets
<span class="co"># return names of markets that are still available</span>
available_markets &lt;-<span class="st"> </span><span class="kw">names</span>(marketIds[test])

<span class="co"># loop through each market and retrieve data, add currentTime to make comparison easier</span>
plyr::<span class="kw">l_ply</span>(available_markets, function(i, files, currentTime, bf, markets) {

    filename &lt;-<span class="st"> </span><span class="kw">paste0</span>(i, <span class="st">&quot;.RDS&quot;</span>)
    if(filename %in%<span class="st"> </span>files) {
        tmp &lt;-<span class="st"> </span><span class="kw">readRDS</span>(filename)
    } else {
        tmp &lt;-<span class="st"> </span><span class="kw">list</span>()
    }
    cur &lt;-<span class="st"> </span>markets[[i]]
    cur &lt;-<span class="st"> </span>bf$<span class="kw">marketBook</span>(<span class="dt">marketIds =</span> cur,
                         <span class="dt">priceProjection =</span> <span class="kw">c</span>(<span class="st">&quot;EX_ALL_OFFERS&quot;</span>, <span class="st">&quot;EX_TRADED&quot;</span>))
    cur[[<span class="dv">1</span>]]$collectedAt &lt;-<span class="st"> </span>currentTime

    tmp &lt;-<span class="st"> </span><span class="kw">append</span>(tmp, cur)

    <span class="kw">saveRDS</span>(tmp, filename)

}, <span class="dt">files =</span> files,
    <span class="dt">currentTime =</span> currentTime,
    <span class="dt">bf =</span> bf,
    <span class="dt">markets =</span> marketIds)</code></pre></div>
<a href="https://github.com/durtal/betfaiR" class="github-corner"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#d9230f; color:#fcfcfc; position: absolute; top: 0; border: 0; right: 0;"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>
<style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>


</body>
</html>
